<script type="text/javascript" src="https://js.stripe.com/v2/"></script>
<script type="text/javascript" src="../js/jquery-2.1.4.min.js"></script>
<script type="text/javascript">

  $(document).ready(function() {

    $('.js-only').removeClass('js-only');
    $('.no-js').css('display', 'none');

    $('#cancel').click(function(e) {
      var el = $('#cancelParent');
      var delay = 3;

      function waitCheck() {
        delay--;
        if(delay > 0) {
          el.html("Wait " + delay + " seconds");
          setTimeout(waitCheck, 1000);
        } else {
          var a = document.createElement("A");
          a.href = "#";
          a.innerHTML = "Click again to confirm that you really want to cancel your subscription.";
          el.html(a);

          $(a).click(function(e) {
            $("#cancelForm").submit();
          });
        }
      }
      delay++;
      waitCheck();

      return false;
    })

    var pubKey = $("#publishableKey").val();
     Stripe.setPublishableKey(pubKey);

    $('#paymentForm').submit(function(e) {
      $('#saveButton').disabled = true;

      var form = $(this);

      if(!$("input[name=card_name]").val()) {
        // if the card name isn't filled, out, 
        // then we don't have a new credit card number
        // so just clear the fields and submit

        $(".creditcard input").val('');
        form.get(0).submit();
        return false;
      }
  
      Stripe.card.createToken(form, function(status, resp) {
        if(resp.error) {
          alert("TODO handle error: " + resp.error.message);
          return;      
        }
        var token = resp.id;

        var lastTwoDigits = $("input[name=card_number]").val().slice(-2);

        $(".creditcard input").val('');

        form.append($('<input type="hidden" name="lastTwoDigits" />').val(lastTwoDigits));
        form.append($('<input type="hidden" name="stripeToken" />').val(token));

        form.get(0).submit();

      });
      return false;
    });


  });
</script>

<input type="hidden" id="publishableKey" />

<form id="paymentForm" method="post" class="chunk">

  <noscript>  
    <h1 style="color:red">
      javascript disabled warning
    </h1>

    <div class="block" style="color:red">
      Your browser does not support javascript. You can change your recurring payment amount and cancel your recurring payment, but you cannot set up a new recurring payment, nor can you change your credit card unless you enable javascript! This is because we do not store your credit card information on our own servers and it is impossible to send your credit card info directly to the credit card processor without javascript.
    </div>
  </noscript>

  <h1>recurring payment status</h1>
    
  <div class="block">
    <div key="status">
    </div>
  </div>

  <h1 key="subHeader">subscription type</h1>

  <table key="subTable">
    <tr>
      <th>Monthly subscription</th>
      <td>
        <select name="subscription_plan">
          <!-- filled out by server side js -->
        </select>
      </td>
    </tr>
  </table>

  <div id="cancelParent" class="js-only">
    <a href="#" id="cancel"></a>
  </div>

  <h1 key="cc_title"></h1>
  <p key="cc_current"></p>

  <table class="creditcard js-only">
    <tr>
      <th>Cardholder name</th>
      <td><input type="text" name="card_name" data-stripe="name">
        (as written on card)
      </td>
    </tr>
    <tr>
      <th>Card number</th>
      <td><input type="text" name="card_number" data-stripe="number"></td>
    </tr>
    <tr>
      <th>Expiration month</th>
      <td><input type="text" name="exp_month" data-stripe="exp_month">
        (e.g. 03)
      </td> 
    </tr>
    <tr>
      <th>Expiration year</th>
      <td><input type="text" name="exp_year" data-stripe="exp_year">
        (e.g. 17)
      </td> 
    </tr>
    <tr>
      <th>Card security code</th>
      <td><input type="text" name="cvc" data-stripe="cvc">
        (last three digits on back of card)
      </td> 
    </tr>
  </table>

  <div class="block center">
    <button id="saveButton" class="bigred">save</button>
  </div>
</form>
<p></p>
<form id="cancelForm" method="post" class="chunk no-js">
  <h1>cancel recurring payment</h1>
  <input type="hidden" name="cancel" value="yes" />
  <input type="submit" value="Click to cancel your recurring payment" />
</form>

